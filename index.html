<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rx Hunt - Pharmacy Treasure Hunt</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Confetti for the win -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Light green tint */
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px -10px rgba(22, 163, 74, 0.2);
        }

        .slide-in {
            animation: slideUp 0.5s ease-out forwards;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #16a34a;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        // Icons
        const Camera = (p) => <IconBase {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" /><circle cx="12" cy="13" r="3" /></IconBase>;
        const MapPin = (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></IconBase>;
        const Leaf = (p) => <IconBase {...p}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.5 2 4.5a7.29 7.29 0 0 1-8 13.5Z" /><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12" /></IconBase>;
        const FlaskConical = (p) => <IconBase {...p}><path d="M10 2v7.527a2 2 0 0 1 .211.896v.077a2 2 0 0 1-.211.896L5 20h14l-5-8.604a2 2 0 0 1-.211-.896v-.077a2 2 0 0 1 .211-.896L14 2" /><path d="M8.5 2h7" /></IconBase>;
        const Coffee = (p) => <IconBase {...p}><path d="M17 8h1a4 4 0 1 1 0 8h-1" /><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z" /><line x1="6" y1="1" x2="6" y2="4" /><line x1="10" y1="1" x2="10" y2="4" /><line x1="14" y1="1" x2="14" y2="4" /></IconBase>;
        const GraduationCap = (p) => <IconBase {...p}><path d="M22 10v6M2 10l10-5 10 5-10 5z" /><path d="M6 12v5c3 3 9 3 12 0v-5" /></IconBase>;
        const Trophy = (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M9 22v-2.19a8.55 8.55 0 0 1 0-11.41V2.4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v6a8.55 8.55 0 0 1 0 11.41V22" /></IconBase>;
        const Stethoscope = (p) => <IconBase {...p}><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.3.3 0 1 0 .2.3" /><path d="M8 15v6" /><path d="M11 21a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" /></IconBase>;
        const ArrowRight = (p) => <IconBase {...p}><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></IconBase>;
        const AlertCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></IconBase>;
        const Users = (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const Mail = (p) => <IconBase {...p}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></IconBase>;
        const Check = (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12" /></IconBase>;
        const Activity = (p) => <IconBase {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></IconBase>;
        const Book = (p) => <IconBase {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" /><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" /></IconBase>;

        const ICONS = { MapPin, Leaf, FlaskConical, Coffee, GraduationCap, Trophy, Stethoscope, ArrowRight, AlertCircle, Camera, X, Upload, Users, Mail, Check, Activity, Book };

        // --- HELPER: Resize Image (Crucial for storage limits & iOS Scanner) ---
        const resizeImage = (file, maxWidth = 800, quality = 0.8) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality)); // Compress quality
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        // --- QUESTION DATA (Imported from Excel/CSV) ---
        // Format: { level: 1, text: "Clue...", hint: "Hint...", answer: "QR Code Content" }
        const QUEST_DB = [
            // LEVEL 1
            { level: 1, text: "I am the brain of this massive place, Where files move at a steady pace. Named after a leader, simple and true, Who gave the slogan 'Jai Jawan' to you. Find the building where the decisions are made.", hint: "Whom this building is named after shares his birthday with which other famous Indian leader?", answer: "Pharmafest_Shastri Bhavan" },
            { level: 1, text: "With poems of India and words so sweet, I stand in stone where the pathways meet. I was the first woman Governor, history will tell, Find the 'Nightingale' who served India well", hint: "A tribute to the 'Nightingale of India'.", answer: "Pharmafest_Sarojini Naidu Statue" },
            { level: 1, text: "White coats and stethoscopes pass through my door, Learning to heal the sick and the poor. I am not a temple, but I save lives too, Find the place where the heartbeat is true.", hint: "Hospital", answer: "Pharmafest_PSH" },
            { level: 1, text: "I focus on the soil, the seed, and the grain, Without my science, there is no harvest to gain. Look for the building where nature is class, And students study the crops and the grass", hint: "The Faculty of Agriculture, usually surrounded by greenery.", answer: "Pharmafest_Agricultural Building" },
            { level: 1, text: "Known as the Iron Lady, strong and bold, A Prime Minister's story, famously told. I stand tall watching the traffic go by, Find the lady with the determined eye.", hint: "A statue of the 'Iron Lady of India'.", answer: "Pharmfest_Indira Gandhi Statue" },
            
            // LEVEL 2
            { level: 2, text: "Plans pause here without permission. Conversations begin strong and dissolve halfway. Cups leave empty, minds leave crowded. This place measures time in refills, not minutes.", hint: "Morning crowd", answer: "Pharmafest2026_teapost" },
            { level: 2, text: "Plans pause here without permission. Conversations begin strong and dissolve halfway. Cups leave empty, minds leave crowded. This place measures time in refills, not minutes.", hint: "Morning crowd", answer: "Pharmafest2026_teapost" }, // Duplicate in source, included as option
            { level: 2, text: "Healing is approached gently here, never forcefully. Care is practiced before authority is earned.", hint: "Caregivers", answer: "Pharmafest2026_nursing" },
            { level: 2, text: "A mind proved light could be questioned. Now his name shelters curiosity.", hint: "Scientist", answer: "Pharmafest2026_cvr" },
            { level: 2, text: "No attendance, no questions, no judgment.", hint: "Faith", answer: "Pharmafest2026_temple" },

            // LEVEL 3
            { level: 3, text: "Always watching, never seen. Memory exists without opinion.", hint: "Surveillance", answer: "Pharmafest2026_security" },
            { level: 3, text: "Authority without paperwork, presence without noise.", hint: "Permissions", answer: "Pharmafest2026_admin" },
            { level: 3, text: "Ideas are turned into strategies here.", hint: "Business", answer: "Pharmafest2026_management" },

            // LEVEL 4
            { level: 4, text: "Before answers exist, tools are chosen. Knowledge waits on shelves.", hint: "Supplies", answer: "Pharmafest2026_stationery" },
            { level: 4, text: "Discipline is measured, not discussed.", hint: "Fitness", answer: "Pharmafest2026_gym" },

            // LEVEL 5
            { level: 5, text: "White coats here do not rush toward patients. They move toward doubt. Molecules are not trusted because they are written, but because they survive testing. If pharmacy had a courtroom, this would be where evidence is presented.", hint: "Research over treatment.", answer: "Pharmafest2026_research" }
        ];

        // --- DYNAMIC ICON LOGIC ---
        const getIconForText = (text, hint) => {
            const t = (text + " " + hint).toLowerCase();
            if (t.includes('tea') || t.includes('cup') || t.includes('food') || t.includes('crowd')) return 'Coffee';
            if (t.includes('garden') || t.includes('plant') || t.includes('green') || t.includes('soil') || t.includes('harvest')) return 'Leaf';
            if (t.includes('lab') || t.includes('chemic') || t.includes('react') || t.includes('research') || t.includes('molecule')) return 'FlaskConical';
            if (t.includes('book') || t.includes('library') || t.includes('read') || t.includes('shelf') || t.includes('shelves')) return 'Book';
            if (t.includes('medic') || t.includes('doctor') || t.includes('hosp') || t.includes('heal') || t.includes('nurs')) return 'Stethoscope';
            if (t.includes('gym') || t.includes('fit') || t.includes('discipline')) return 'Activity';
            if (t.includes('statue') || t.includes('leader') || t.includes('lady') || t.includes('governor')) return 'Users';
            if (t.includes('temple') || t.includes('faith')) return 'MapPin';
            if (t.includes('admin') || t.includes('auth')) return 'MapPin';
            if (t.includes('securit') || t.includes('watch')) return 'Camera';
            return 'MapPin';
        };

        const RxHuntApp = () => {
            // App State
            const [gameState, setGameState] = useState('LOADING'); // LOADING, REGISTER, PLAYING, WON
            const [teamInfo, setTeamInfo] = useState({ name: '', institute: '', startTime: 0 });
            const [assignedRoute, setAssignedRoute] = useState([]); // Array of question objects
            
            // Game Progress State
            const [currentLevel, setCurrentLevel] = useState(0);
            const [gameStep, setGameStep] = useState('HUNT'); // HUNT (Entering Code) or PROOF (Taking Photo)
            
            // Inputs
            const [inputCode, setInputCode] = useState("");
            const [photoPreview, setPhotoPreview] = useState(null);
            const [error, setError] = useState("");
            const [showHint, setShowHint] = useState(false);
            const [processingFile, setProcessingFile] = useState(false);

            // Refs
            const qrInputRef = useRef(null);
            const proofInputRef = useRef(null);

            // --- INITIALIZATION ---
            useEffect(() => {
                const savedTeam = localStorage.getItem('rxHuntTeam');
                const savedRoute = localStorage.getItem('rxHuntRoute');
                const savedLevel = localStorage.getItem('rxHuntLevel');
                
                if (savedTeam && savedRoute) {
                    const parsedTeam = JSON.parse(savedTeam);
                    const parsedRoute = JSON.parse(savedRoute);
                    setTeamInfo(parsedTeam);
                    setAssignedRoute(parsedRoute);
                    
                    if (savedLevel) {
                        const level = parseInt(savedLevel);
                        const maxLevels = parsedRoute.length;
                        
                        if (level >= maxLevels) {
                            setGameState('WON');
                            setCurrentLevel(maxLevels);
                        } else {
                            setGameState('PLAYING');
                            setCurrentLevel(level);
                        }
                    } else {
                        setGameState('PLAYING');
                    }
                } else {
                    setGameState('REGISTER');
                }
            }, []);

            // --- REGISTRATION LOGIC ---
            const handleRegistration = (e) => {
                e.preventDefault();
                const form = e.target;
                const name = form.teamName.value;
                const institute = form.instituteName.value;
                
                if(!name || !institute) {
                    setError("Please fill in all fields");
                    return;
                }

                // RANDOMIZE ROUTE
                const newRoute = [];
                // There are 5 levels total
                for (let i = 1; i <= 5; i++) {
                    const questionsForLevel = QUEST_DB.filter(q => q.level === i);
                    if (questionsForLevel.length > 0) {
                        const randomQ = questionsForLevel[Math.floor(Math.random() * questionsForLevel.length)];
                        newRoute.push(randomQ);
                    }
                }

                if (newRoute.length === 0) {
                    setError("System Error: No questions loaded. Contact admin.");
                    return;
                }
                
                const newTeam = { 
                    name, 
                    institute, 
                    startTime: Date.now()
                };
                
                localStorage.setItem('rxHuntTeam', JSON.stringify(newTeam));
                localStorage.setItem('rxHuntRoute', JSON.stringify(newRoute));
                localStorage.setItem('rxHuntLevel', 0);
                localStorage.setItem('rxHuntProofs', JSON.stringify([])); // Reset proofs
                
                setTeamInfo(newTeam);
                setAssignedRoute(newRoute);
                setGameState('PLAYING');
                setCurrentLevel(0);
                setGameStep('HUNT');
            };

            // --- QR/CODE SCAN LOGIC ---
            const handleQrScan = async (e) => {
                if (e.target.files.length === 0) return;
                const originalFile = e.target.files[0];
                setProcessingFile(true);
                setError("");

                try {
                    // Resize image first to avoid iOS memory limits and format issues
                    // 800px is usually enough for QR codes, 0.9 quality
                    const resizedDataUrl = await resizeImage(originalFile, 800, 0.9);
                    
                    // Convert DataURL to File for html5-qrcode
                    const res = await fetch(resizedDataUrl);
                    const blob = await res.blob();
                    const resizedFile = new File([blob], "temp_qr.jpg", { type: "image/jpeg" });

                    const html5QrCode = new Html5Qrcode("reader-hidden");
                    const decodedText = await html5QrCode.scanFile(resizedFile, false);
                    
                    setInputCode(decodedText);
                    setProcessingFile(false);
                    
                    // Cleanup
                    try { html5QrCode.clear(); } catch(e){}
                    
                } catch (err) {
                    console.error("QR Scan Error:", err);
                    setError("Could not read QR code. Try moving closer or cleaning the lens.");
                    setProcessingFile(false);
                }
            };

            // --- PHOTO PROOF LOGIC (With Resizing) ---
            const handleProofUpload = async (e) => {
                if (e.target.files.length === 0) return;
                const file = e.target.files[0];
                
                // Resize to prevent localStorage quota exceeded errors
                try {
                    const resizedImage = await resizeImage(file, 600, 0.7);
                    setPhotoPreview(resizedImage);
                } catch (err) {
                    console.error("Error resizing image", err);
                    setError("Could not process image.");
                }
            };

            // --- GAME LOOP ---
            const handleSubmitCode = (e) => {
                e.preventDefault();
                const currentData = assignedRoute[currentLevel];
                
                // Flexible matching: check if the scanned code contains the answer key (case insensitive)
                // or if the answer key contains the scanned code (for partial scans)
                if (inputCode && currentData && 
                   (inputCode.trim().toUpperCase() === currentData.answer.toUpperCase() || 
                    inputCode.trim().toUpperCase().includes(currentData.answer.toUpperCase()))) {
                    
                    // Correct Code -> Move to Photo Proof Step
                    setError("");
                    setGameStep('PROOF');
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                } else {
                    setError("Incorrect QR Code for this location.");
                    shakeInput('code-input');
                }
            };

            const confirmProofAndAdvance = () => {
                // Save proof to storage
                const currentProofs = JSON.parse(localStorage.getItem('rxHuntProofs') || '[]');
                currentProofs[currentLevel] = photoPreview; // Save at index
                localStorage.setItem('rxHuntProofs', JSON.stringify(currentProofs));

                const nextLevel = currentLevel + 1;
                
                if (nextLevel >= assignedRoute.length) {
                    finishGame();
                } else {
                    advanceLevel(nextLevel);
                }
            };

            const advanceLevel = (level) => {
                localStorage.setItem('rxHuntLevel', level);
                setCurrentLevel(level);
                setGameStep('HUNT');
                setInputCode("");
                setPhotoPreview(null);
                setShowHint(false);
                window.scrollTo(0,0);
            };

            const finishGame = () => {
                const endTime = Date.now();
                localStorage.setItem('rxHuntLevel', assignedRoute.length);
                localStorage.setItem('rxHuntEndTime', endTime); // Save end time
                setGameState('WON');
                fireWorks();
            };

            const generateReport = () => {
                // 1. Gather Data
                const proofs = JSON.parse(localStorage.getItem('rxHuntProofs') || '[]');
                const endTime = parseInt(localStorage.getItem('rxHuntEndTime') || Date.now());
                const timeTaken = Math.floor((endTime - teamInfo.startTime) / 60000); // Minutes

                // 2. Build HTML Content
                let htmlContent = `
                    <html>
                    <head>
                        <title>Rx Hunt Report - ${teamInfo.name}</title>
                        <style>
                            body { font-family: sans-serif; padding: 20px; color: #1a202c; }
                            h1 { color: #16a34a; border-bottom: 2px solid #16a34a; padding-bottom: 10px; }
                            .info { background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                            .proof-item { margin-bottom: 30px; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; }
                            .proof-img { max-width: 100%; height: auto; border-radius: 4px; display: block; margin-top: 10px; }
                        </style>
                    </head>
                    <body>
                        <h1>Rx Hunt Completion Report</h1>
                        <div class="info">
                            <p><strong>Team Name:</strong> ${teamInfo.name}</p>
                            <p><strong>Institute:</strong> ${teamInfo.institute}</p>
                            <p><strong>Total Time:</strong> ${timeTaken} minutes</p>
                            <p><strong>Finished At:</strong> ${new Date(endTime).toLocaleString()}</p>
                        </div>
                        <h2>Route & Proofs</h2>
                `;

                proofs.forEach((imgData, index) => {
                    if(index < assignedRoute.length) {
                        const question = assignedRoute[index];
                        htmlContent += `
                            <div class="proof-item">
                                <h3>Level ${index + 1} Answer: ${question.answer}</h3>
                                <p><em>Clue: ${question.text}</em></p>
                                <img src="${imgData}" class="proof-img" />
                            </div>
                        `;
                    }
                });

                htmlContent += `</body></html>`;

                // 3. Create Download
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `RxHunt_Report_${teamInfo.name.replace(/\s+/g, '_')}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // 4. Open Email Client
                const subject = encodeURIComponent(`Rx Hunt Report - ${teamInfo.name}`);
                const body = encodeURIComponent(
                    `Hello,\n\nHere is the completion report for Team ${teamInfo.name} from ${teamInfo.institute}.\n\n` +
                    `Time Taken: ${timeTaken} minutes.\n\n` +
                    `*** IMPORTANT: I have attached the downloaded report file (RxHunt_Report_${teamInfo.name.replace(/\s+/g, '_')}.html) to this email which contains our proof photos. ***`
                );
                
                window.location.href = `mailto:john.mpharm@gmail.com?subject=${subject}&body=${body}`;
            };

            const fireWorks = () => {
                const duration = 3000;
                const end = Date.now() + duration;
                (function frame() {
                    confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#22c55e', '#ffffff'] });
                    confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#22c55e', '#ffffff'] });
                    if (Date.now() < end) requestAnimationFrame(frame);
                }());
            };

            const resetGame = () => {
                if(confirm("Are you sure? This will delete your team registration and progress.")){
                    localStorage.clear();
                    window.location.reload();
                }
            };

            const shakeInput = (id) => {
                const el = document.getElementById(id);
                if(el) {
                    el.classList.add('translate-x-2');
                    setTimeout(() => el.classList.remove('translate-x-2'), 100);
                    setTimeout(() => el.classList.add('-translate-x-2'), 200);
                    setTimeout(() => el.classList.remove('-translate-x-2'), 300);
                }
            };

            const getIcon = (iconName) => {
                const IconComponent = ICONS[iconName] || MapPin;
                return <IconComponent size={48} className="text-green-600 mb-4" />;
            };

            // --- VIEW: LOADING ---
            if (gameState === 'LOADING') return <div className="min-h-screen flex items-center justify-center"><div className="spinner"></div></div>;

            // --- VIEW: REGISTRATION ---
            if (gameState === 'REGISTER') {
                return (
                    <div className="min-h-screen bg-green-50 flex items-center justify-center p-6">
                        <div className="glass-panel w-full max-w-md p-8 rounded-3xl shadow-xl slide-in">
                            <div className="text-center mb-6">
                                {/* LOGO SECTION */}
                                <div className="flex justify-center mb-6">
                                    <img 
                                        src="parul_university_logo.png" 
                                        alt="Parul University Logo" 
                                        className="h-32 object-contain"
                                        onError={(e) => {
                                            e.target.style.display = 'none'; 
                                            document.getElementById('fallback-icon').style.display = 'inline-block';
                                        }} 
                                    />
                                    {/* Fallback icon if image is missing */}
                                    <div id="fallback-icon" className="hidden p-3 bg-green-100 rounded-2xl text-green-700">
                                        <Users size={40} />
                                    </div>
                                </div>
                                
                                <h1 className="text-3xl font-bold text-green-900">Rx Hunt</h1>
                                <p className="text-green-700 mt-2 font-medium">Parul University Pharmacy Treasure Hunt</p>
                            </div>
                            
                            <form onSubmit={handleRegistration} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Team Name</label>
                                    <input name="teamName" type="text" placeholder="e.g. The Pill Poppers" className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition-all" />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Institute Name</label>
                                    <input name="instituteName" type="text" placeholder="e.g. Parul Institute of Pharmacy" className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition-all" />
                                </div>

                                {error && <div className="text-red-500 text-sm font-medium text-center">{error}</div>}

                                <button type="submit" className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all transform active:scale-95">
                                    Start Adventure
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // --- VIEW: VICTORY ---
            if (gameState === 'WON') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-green-50 text-center">
                        <div className="glass-panel p-8 rounded-3xl w-full max-w-md slide-in">
                            <div className="flex justify-center mb-6"><Trophy size={80} className="text-yellow-500" /></div>
                            <h1 className="text-4xl font-extrabold text-green-800 mb-4">Mission Complete!</h1>
                            <p className="text-gray-600 mb-2 text-lg">Congratulations <strong>{teamInfo.name}</strong>!</p>
                            <p className="text-sm text-green-600 mb-8">{teamInfo.institute}</p>
                            
                            <div className="space-y-3">
                                <button onClick={generateReport} className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg w-full flex items-center justify-center gap-2 transition-all">
                                    <Mail size={20} /> Generate & Email Report
                                </button>
                                <p className="text-xs text-gray-500 max-w-xs mx-auto px-4 leading-relaxed">
                                    Note: This will download a report file. Please attach it to the email that opens.
                                </p>
                            </div>

                            <button onClick={resetGame} className="mt-8 text-green-600 underline text-sm">Reset App / New Game</button>
                        </div>
                    </div>
                );
            }

            // --- VIEW: GAMEPLAY ---
            if (!assignedRoute || assignedRoute.length === 0) return <div>Loading route...</div>;
            
            const activeData = assignedRoute[currentLevel];
            const iconName = getIconForText(activeData.text, activeData.hint);

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 p-4 pb-20 relative">
                    {/* Hidden Inputs */}
                    <div id="reader-hidden" className="hidden"></div>
                    <input type="file" ref={qrInputRef} accept="image/*" capture="environment" className="hidden" onChange={handleQrScan} />
                    <input type="file" ref={proofInputRef} accept="image/*" capture="environment" className="hidden" onChange={handleProofUpload} />

                    {/* Header */}
                    <div className="flex justify-between items-center mb-6 pt-2 px-2">
                        <div className="flex flex-col">
                            <span className="font-bold text-lg text-green-900 leading-tight">{teamInfo.name}</span>
                        </div>
                        <div className="text-sm font-semibold text-green-700 bg-green-200 px-3 py-1 rounded-full">
                            Lvl {currentLevel + 1}/{assignedRoute.length}
                        </div>
                    </div>

                    {/* Main Card */}
                    <div className="glass-panel rounded-3xl p-6 shadow-xl slide-in max-w-lg mx-auto">
                        
                        {/* STEP 1: HUNTING (CLUE & CODE) */}
                        {gameStep === 'HUNT' && (
                            <>
                                <div className="flex flex-col items-center text-center mb-6">
                                    {getIcon(iconName)}
                                    <h2 className="text-2xl font-bold text-gray-800 mb-2">Clue #{currentLevel + 1}</h2>
                                    <div className="h-1 w-20 bg-green-500 rounded-full mb-6"></div>
                                    <p className="text-lg text-gray-700 font-medium">"{activeData.text}"</p>
                                </div>

                                <div className="mb-8 text-center">
                                    {!showHint ? (
                                        <button onClick={() => setShowHint(true)} className="text-sm text-green-600 underline">Need a hint?</button>
                                    ) : (
                                        <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 p-3 rounded-xl text-sm flex gap-2">
                                            <AlertCircle size={16} className="mt-0.5 shrink-0" />
                                            <span>{activeData.hint}</span>
                                        </div>
                                    )}
                                </div>

                                <form onSubmit={handleSubmitCode} className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-2 ml-1 uppercase tracking-wider">Secret Code (QR Only)</label>
                                        
                                        {!inputCode ? (
                                            <button 
                                                type="button" 
                                                onClick={() => qrInputRef.current.click()} 
                                                disabled={processingFile} 
                                                className="w-full bg-green-50 text-green-700 p-8 rounded-2xl border-2 border-dashed border-green-300 hover:bg-green-100 transition-all flex flex-col items-center gap-3 group"
                                            >
                                                {processingFile ? (
                                                    <div className="spinner"></div>
                                                ) : (
                                                    <>
                                                        <div className="bg-white p-3 rounded-full shadow-sm group-hover:scale-110 transition-transform">
                                                            <Camera size={32} />
                                                        </div>
                                                        <span className="font-bold">Tap to Scan QR Code</span>
                                                    </>
                                                )}
                                            </button>
                                        ) : (
                                            <div className="bg-white border-2 border-green-500 rounded-xl p-4 text-center relative overflow-hidden">
                                                <div className="absolute top-0 left-0 w-full h-1 bg-green-500"></div>
                                                <p className="text-xs text-gray-500 uppercase tracking-widest mb-1">Scanned Code</p>
                                                <p className="text-2xl font-mono font-bold text-green-800 tracking-wider mb-3 break-all">{inputCode}</p>
                                                <button 
                                                    type="button" 
                                                    onClick={() => {setInputCode(""); setError("");}} 
                                                    className="text-xs text-red-500 hover:text-red-700 font-semibold flex items-center justify-center gap-1 mx-auto"
                                                >
                                                    <X size={14} /> Scan Different Code
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    {error && <div className="text-red-500 text-sm font-medium text-center bg-red-50 p-2 rounded-lg border border-red-100">{error}</div>}
                                    
                                    {inputCode && (
                                        <button type="submit" className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                                            Verify Answer <ArrowRight size={20} />
                                        </button>
                                    )}
                                </form>
                            </>
                        )}

                        {/* STEP 2: PHOTO PROOF */}
                        {gameStep === 'PROOF' && (
                            <div className="text-center animate-pulse-once">
                                <div className="bg-green-100 rounded-full p-4 w-20 h-20 mx-auto mb-4 flex items-center justify-center text-green-600">
                                    <Camera size={40} />
                                </div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">One Last Step!</h2>
                                <p className="text-gray-600 mb-6">Take a selfie or photo of the location to prove you are really there.</p>

                                {!photoPreview ? (
                                    <button onClick={() => proofInputRef.current.click()} className="w-full border-2 border-dashed border-green-400 bg-green-50 hover:bg-green-100 text-green-700 rounded-2xl p-8 flex flex-col items-center gap-2 transition-all">
                                        <Upload size={32} />
                                        <span className="font-semibold">Tap to Take Photo</span>
                                    </button>
                                ) : (
                                    <div className="space-y-4">
                                        <div className="relative rounded-2xl overflow-hidden border-4 border-green-200 shadow-inner">
                                            <img src={photoPreview} className="w-full h-48 object-cover" alt="Proof" />
                                            <button onClick={() => setPhotoPreview(null)} className="absolute top-2 right-2 bg-white text-red-500 p-1 rounded-full shadow-md"><X size={20}/></button>
                                        </div>
                                        <button onClick={confirmProofAndAdvance} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2">
                                            Confirm & Continue <ArrowRight size={20} />
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RxHuntApp />);
    </script>
</body>
</html>
