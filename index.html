<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rx Hunt - PharmaFest 2026</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4;
            overscroll-behavior-y: none; /* Prevents pull-to-refresh on mobile */
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px -10px rgba(22, 163, 74, 0.15);
        }

        .slide-in { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Disable selecting text to prevent copy-pasting clues */
        .no-select { user-select: none; -webkit-user-select: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. CONFIGURATION & DATA ---
        
        // ðŸ”’ SECURITY: Use "answerHash" instead of "answer" for production.
        // Use the Dev Mode (Tap Title 5x) to generate these hashes.
        const QUEST_DB = [
            { 
                level: 1, 
                text: "I am the brain of this massive place, Where files move at a steady pace. Named after a leader, simple and true.", 
                hint: "Shastri Bhavan", 
                answer: "Pharmafest_Shastri Bhavan", // Legacy (Plain Text)
                // answerHash: "a591a6d40bf420404a011733cfb7b190d62c65bf0bcda32b57b277d9ad9f146e", // Secure (Example)
                // lat: 22.2889, lng: 73.3635, // Optional: Add Geolocation (Parul Uni Coords)
                // radius: 50 // meters
            },
            { level: 1, text: "With poems of India and words so sweet, I stand in stone where the pathways meet.", hint: "Sarojini Naidu Statue", answer: "Pharmafest_Sarojini Naidu Statue" },
            { level: 1, text: "White coats and stethoscopes pass through my door. I am not a temple, but I save lives too.", hint: "PSH Hospital", answer: "Pharmafest_PSH" },
            { level: 2, text: "Plans pause here without permission. Conversations begin strong and dissolve halfway. Cups leave empty.", hint: "Tea Post", answer: "Pharmafest2026_teapost" },
            { level: 3, text: "Always watching, never seen. Memory exists without opinion.", hint: "Security/CCTV", answer: "Pharmafest2026_security" },
            { level: 5, text: "White coats here do not rush toward patients. They move toward doubt. Molecules are trusted because they survive testing.", hint: "Research Center", answer: "Pharmafest2026_research" }
        ];

        // --- 2. UTILITIES ---

        // Async SHA-256 Hashing
        const hashString = async (message) => {
            const msgBuffer = new TextEncoder().encode(message.trim().toUpperCase()); // Normalize input
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        };

        // Haversine Formula for GPS Distance (in meters)
        const getDistanceFromLatLonInM = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; // Earth radius in meters
            const dLat = (lat2 - lat1) * (Math.PI/180);
            const dLon = (lon2 - lon1) * (Math.PI/180);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        const resizeImage = (file, maxWidth = 800) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        // --- 3. ICONS ---
        const Icon = ({ p, c, s=24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={c}><path d={p} /></svg>;
        const Icons = {
            Camera: () => <Icon p="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />,
            MapPin: () => <Icon p="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />,
            Check: () => <Icon p="M20 6L9 17l-5-5" />,
            X: () => <Icon p="M18 6L6 18M6 6l12 12" />,
            Lock: () => <Icon p="M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2zm-7 0V7a5 5 0 0 1 10 0v4" />,
            Alert: () => <Icon p="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4m0 4h.01" />
        };

        // --- 4. MAIN APP COMPONENT ---
        const RxHuntApp = () => {
            // State
            const [gameState, setGameState] = useState('LOADING');
            const [teamInfo, setTeamInfo] = useState({ name: '', institute: '' });
            const [route, setRoute] = useState([]);
            const [level, setLevel] = useState(0);
            const [step, setStep] = useState('HUNT'); // HUNT, PROOF
            const [inputCode, setInputCode] = useState("");
            const [photo, setPhoto] = useState(null);
            const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);
            const [gpsLoading, setGpsLoading] = useState(false);
            
            // Dev Mode State
            const [devMode, setDevMode] = useState(false);
            const [tapCount, setTapCount] = useState(0);
            const [lastScanHash, setLastScanHash] = useState("");
            const [currentGPS, setCurrentGPS] = useState(null);

            // Refs
            const qrRef = useRef(null);
            const proofRef = useRef(null);

            useEffect(() => {
                const savedTeam = localStorage.getItem('rxTeam');
                const savedRoute = localStorage.getItem('rxRoute');
                const savedLevel = localStorage.getItem('rxLevel');

                if (savedTeam && savedRoute) {
                    setTeamInfo(JSON.parse(savedTeam));
                    setRoute(JSON.parse(savedRoute));
                    const l = parseInt(savedLevel || '0');
                    if (l >= JSON.parse(savedRoute).length) setGameState('WON');
                    else {
                        setGameState('PLAYING');
                        setLevel(l);
                    }
                } else {
                    setGameState('REGISTER');
                }
            }, []);

            // --- LOGIC: REGISTRATION ---
            const register = (e) => {
                e.preventDefault();
                const name = e.target.team.value;
                const inst = e.target.inst.value;
                if (!name || !inst) return setError("Required fields missing");

                // Generate Route: Pick 1 random question per level
                const newRoute = [];
                [1, 2, 3, 5].forEach(l => {
                    const pool = QUEST_DB.filter(q => q.level === l);
                    if (pool.length) newRoute.push(pool[Math.floor(Math.random() * pool.length)]);
                });

                if (newRoute.length === 0) newRoute.push(...QUEST_DB.slice(0, 5)); // Fallback

                const team = { name, institute: inst, start: Date.now() };
                localStorage.setItem('rxTeam', JSON.stringify(team));
                localStorage.setItem('rxRoute', JSON.stringify(newRoute));
                localStorage.setItem('rxLevel', 0);
                localStorage.setItem('rxProofs', JSON.stringify([]));
                
                setTeamInfo(team);
                setRoute(newRoute);
                setGameState('PLAYING');
            };

            // --- LOGIC: QR SCAN & PROCESS ---
            const handleScan = async (e) => {
                if (!e.target.files.length) return;
                setLoading(true);
                setError("");
                
                try {
                    const resizedUrl = await resizeImage(e.target.files[0], 800);
                    const res = await fetch(resizedUrl);
                    const blob = await res.blob();
                    const file = new File([blob], "qr.jpg", { type: "image/jpeg" });

                    const scanner = new Html5Qrcode("reader-hidden");
                    const text = await scanner.scanFile(file, false);
                    scanner.clear();

                    setInputCode(text);

                    // If Dev Mode, show hash and GPS immediately
                    if (devMode) {
                        const h = await hashString(text);
                        setLastScanHash(h);
                        navigator.geolocation.getCurrentPosition(
                            (pos) => setCurrentGPS({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                            () => setCurrentGPS({ error: "GPS Failed" })
                        );
                    }

                } catch (err) {
                    console.error(err);
                    setError("Could not read QR. Clean lens & try again.");
                }
                setLoading(false);
            };

            // --- LOGIC: VERIFY ANSWER ---
            const verifyAnswer = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError("");

                const currentQ = route[level];
                
                // 1. Check GPS (Geofencing) if defined in DB
                if (currentQ.lat && currentQ.lng) {
                    setGpsLoading(true);
                    try {
                        const pos = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 5000 });
                        });
                        
                        const dist = getDistanceFromLatLonInM(pos.coords.latitude, pos.coords.longitude, currentQ.lat, currentQ.lng);
                        const limit = currentQ.radius || 60; // Default 60 meters radius

                        if (dist > limit) {
                            setGpsLoading(false);
                            setLoading(false);
                            setError(`Wrong Location! You are ${Math.round(dist)}m away. Go closer to the target.`);
                            return;
                        }
                    } catch (gpsErr) {
                        setGpsLoading(false);
                        setLoading(false);
                        setError("GPS Error: Enable location permissions to verify.");
                        return;
                    }
                    setGpsLoading(false);
                }

                // 2. Check Code (Hash or Plain)
                let isCorrect = false;
                
                if (currentQ.answerHash) {
                    const inputHash = await hashString(inputCode);
                    // Check direct match OR if user input is contained in answer (rare)
                    if (inputHash === currentQ.answerHash) isCorrect = true;
                } else if (currentQ.answer) {
                    // Fallback to plain text (Case Insensitive)
                    if (inputCode.trim().toUpperCase().includes(currentQ.answer.toUpperCase())) isCorrect = true;
                }

                if (isCorrect) {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    setStep('PROOF');
                } else {
                    setError("Incorrect QR Code.");
                }
                setLoading(false);
            };

            const submitProof = async (e) => {
                if (!e.target.files.length) return;
                try {
                    const img = await resizeImage(e.target.files[0], 600);
                    setPhoto(img);
                } catch(err) { setError("Image error"); }
            };

            const confirmLevel = () => {
                // Save proof
                const proofs = JSON.parse(localStorage.getItem('rxProofs') || '[]');
                proofs[level] = photo;
                localStorage.setItem('rxProofs', JSON.stringify(proofs));

                const next = level + 1;
                if (next >= route.length) {
                    localStorage.setItem('rxLevel', next);
                    localStorage.setItem('rxEnd', Date.now());
                    setGameState('WON');
                } else {
                    localStorage.setItem('rxLevel', next);
                    setLevel(next);
                    setStep('HUNT');
                    setInputCode("");
                    setPhoto(null);
                }
                window.scrollTo(0,0);
            };

            const toggleDev = () => {
                const now = Date.now();
                if (tapCount > 3) {
                    setDevMode(!devMode);
                    alert(`Developer Mode ${!devMode ? 'ENABLED' : 'DISABLED'}`);
                    setTapCount(0);
                } else {
                    setTapCount(c => c + 1);
                    setTimeout(() => setTapCount(0), 1000);
                }
            };

            // --- UI RENDER ---

            if (gameState === 'LOADING') return <div className="h-screen flex items-center justify-center"><div className="spinner"></div></div>;

            if (gameState === 'REGISTER') return (
                <div className="min-h-screen bg-green-50 flex flex-col items-center justify-center p-6">
                    <div className="glass-panel w-full max-w-md p-8 rounded-3xl slide-in">
                        <div className="text-center mb-6">
                            <h1 className="text-3xl font-bold text-green-800">Rx Hunt</h1>
                            <p className="text-green-600">PharmaFest 2026</p>
                        </div>
                        <form onSubmit={register} className="space-y-4">
                            <input name="team" placeholder="Team Name" className="w-full p-4 rounded-xl border focus:border-green-500 outline-none" />
                            <input name="inst" placeholder="Institute Name" className="w-full p-4 rounded-xl border focus:border-green-500 outline-none" />
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <button className="w-full bg-green-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-green-700">Start Game</button>
                        </form>
                    </div>
                </div>
            );

            if (gameState === 'WON') return (
                <div className="min-h-screen bg-green-50 p-6 flex items-center justify-center">
                    <div className="glass-panel w-full max-w-md p-8 rounded-3xl text-center slide-in">
                        <h1 className="text-4xl font-bold text-green-800 mb-4">You Won!</h1>
                        <p className="mb-6 text-gray-600">Great job, Team {teamInfo.name}. Head to the registration desk.</p>
                        <button onClick={() => {if(confirm('Reset?')) {localStorage.clear(); window.location.reload();}}} className="text-sm text-gray-400 underline">Reset App</button>
                    </div>
                </div>
            );

            // GAMEPLAY
            const q = route[level];
            
            return (
                <div className="min-h-screen bg-gradient-to-b from-green-50 to-white pb-20 relative">
                    <div id="reader-hidden" className="hidden"></div>
                    
                    {/* Header */}
                    <div className="bg-white/80 backdrop-blur-md sticky top-0 z-10 px-6 py-4 flex justify-between items-center shadow-sm">
                        <h1 className="font-bold text-green-900 select-none" onClick={toggleDev}>Rx Hunt</h1>
                        <span className="bg-green-100 text-green-800 text-xs font-bold px-3 py-1 rounded-full">Level {level + 1}/{route.length}</span>
                    </div>

                    {/* Developer Console (Hidden by default) */}
                    {devMode && (
                        <div className="bg-black text-green-400 p-4 font-mono text-xs m-4 rounded-xl overflow-hidden">
                            <p><strong>DEV MODE ACTIVE</strong></p>
                            <div className="my-2 border-b border-gray-700"></div>
                            <p>Last Scanned Hash:</p>
                            <textarea readOnly className="w-full bg-gray-900 p-2 rounded mb-2 text-white h-16" value={lastScanHash}></textarea>
                            {currentGPS && (
                                <p>GPS: {currentGPS.lat?.toFixed(5)}, {currentGPS.lng?.toFixed(5)}</p>
                            )}
                            <p className="text-gray-500 mt-2">Copy these to QUEST_DB inside index.html</p>
                        </div>
                    )}

                    <div className="p-6 max-w-lg mx-auto">
                        {step === 'HUNT' ? (
                            <div className="glass-panel p-6 rounded-3xl space-y-6 slide-in">
                                {/* Clue */}
                                <div className="text-center">
                                    <div className="inline-block p-3 bg-green-100 rounded-full text-green-600 mb-3"><Icons.MapPin /></div>
                                    <h2 className="text-xl font-bold text-gray-800 mb-2">Find Location #{level + 1}</h2>
                                    <p className="text-lg text-gray-600 italic no-select">"{q.text}"</p>
                                    <p className="mt-4 text-xs text-green-600 bg-green-50 inline-block px-3 py-1 rounded-lg border border-green-100">Hint: {q.hint}</p>
                                </div>

                                {/* Scanner Input */}
                                <div className="space-y-4">
                                    {!inputCode ? (
                                        <button onClick={() => qrRef.current.click()} disabled={loading} className="w-full border-2 border-dashed border-green-300 rounded-2xl h-40 flex flex-col items-center justify-center text-green-600 hover:bg-green-50 transition-colors">
                                            {loading ? <div className="spinner"></div> : <><Icons.Camera /><span className="mt-2 font-semibold">Scan QR Code</span></>}
                                        </button>
                                    ) : (
                                        <div className="bg-green-50 border border-green-200 p-4 rounded-xl text-center">
                                            <p className="text-xs text-gray-500 uppercase">Scanned Data</p>
                                            <p className="font-mono font-bold text-green-800 break-all text-sm my-2">{inputCode.substring(0, 20)}...</p>
                                            <button onClick={() => setInputCode("")} className="text-xs text-red-500 font-bold flex items-center justify-center gap-1"><Icons.X s={12}/> Rescan</button>
                                        </div>
                                    )}
                                    
                                    {/* Action Button */}
                                    {inputCode && (
                                        <button onClick={verifyAnswer} disabled={loading || gpsLoading} className="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                                            {gpsLoading ? 'Checking Location...' : 'Verify Location'} {gpsLoading && <div className="spinner border-white border-t-transparent w-4 h-4"></div>}
                                        </button>
                                    )}
                                </div>
                                {error && <div className="bg-red-50 text-red-600 p-3 rounded-xl text-center text-sm font-medium border border-red-100 flex items-center justify-center gap-2"><Icons.Alert s={16}/> {error}</div>}
                            </div>
                        ) : (
                            // PROOF STEP
                            <div className="glass-panel p-6 rounded-3xl space-y-6 slide-in text-center">
                                <div className="inline-block p-4 bg-green-100 rounded-full text-green-600 mb-2"><Icons.Check s={32}/></div>
                                <h2 className="text-2xl font-bold text-gray-800">Correct Location!</h2>
                                <p className="text-gray-600 text-sm">Now upload a selfie/photo to prove you are here.</p>
                                
                                {!photo ? (
                                    <button onClick={() => proofRef.current.click()} className="w-full bg-white border border-gray-200 py-6 rounded-xl shadow-sm font-semibold text-gray-600 hover:bg-gray-50">Take Photo Proof</button>
                                ) : (
                                    <div className="space-y-4">
                                        <img src={photo} className="w-full h-48 object-cover rounded-xl border border-gray-200" />
                                        <button onClick={confirmLevel} className="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg">Submit & Next Level</button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Hidden Inputs */}
                    <input type="file" ref={qrRef} accept="image/*" capture="environment" className="hidden" onChange={handleScan} />
                    <input type="file" ref={proofRef} accept="image/*" capture="environment" className="hidden" onChange={submitProof} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RxHuntApp />);
    </script>
</body>
</html>
