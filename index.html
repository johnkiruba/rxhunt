<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rx Hunt - PharmaFest 2026</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4;
            overscroll-behavior-y: none;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px -10px rgba(22, 163, 74, 0.15);
        }

        .slide-in { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .no-select { user-select: none; -webkit-user-select: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. CONFIGURATION: GEO-FENCED DATA ---
        // Coordinates extracted from your Excel file
        const QUEST_DB = [
            { 
                level: 1, 
                text: "I am the brain of this massive place, Where files move at a steady pace. Named after a leader, simple and true.", 
                hint: "Shastri Bhavan", 
                answer: "Pharmafest_Shastri Bhavan", 
                // Bounds from Excel Row 2
                bounds: { north: 22.2891157, south: 22.2885971, east: 73.3639803, west: 73.3634143 }
            },
            { 
                level: 1, 
                text: "With poems of India and words so sweet, I stand in stone where the pathways meet.", 
                hint: "Sarojini Naidu Statue", 
                answer: "Pharmafest_Sarojini Naidu Statue",
                // Bounds from Excel Row 3
                bounds: { north: 22.2895697, south: 22.2892978, east: 73.3637684, west: 73.3634868 }
            },
            { 
                level: 1, 
                text: "White coats and stethoscopes pass through my door. I am not a temple, but I save lives too.", 
                hint: "PSH Hospital", 
                answer: "Pharmafest_PSH",
                // Bounds from Excel Row 4
                bounds: { north: 22.2872338, south: 22.2868297, east: 73.3644080, west: 73.3638206 }
            },
            { 
                level: 1, 
                text: "I focus on the soil, the seed, and the grain, Without my science, there is no harvest to gain.", 
                hint: "Agricultural Building", 
                answer: "Pharmafest_Agricultural Building",
                // Bounds from Excel Row 5
                bounds: { north: 22.2921508, south: 22.2917757, east: 73.3664726, west: 73.3660300 }
            },
            { 
                level: 1, 
                text: "Known as the Iron Lady, strong and bold. I stand tall watching the traffic go by.", 
                hint: "Indira Gandhi Statue", 
                answer: "Pharmfest_Indira Gandhi Statue",
                // Bounds from Excel Row 6
                bounds: { north: 22.2921703, south: 22.2919864, east: 73.3634560, west: 73.3632388 }
            },
            // Levels 2-5 (No Geofence required for now, but added for structure)
            { level: 2, text: "Plans pause here without permission. Conversations begin strong and dissolve halfway. Cups leave empty.", hint: "Tea Post", answer: "Pharmafest2026_teapost" },
            { level: 3, text: "Always watching, never seen. Memory exists without opinion.", hint: "Security/CCTV", answer: "Pharmafest2026_security" },
            { level: 5, text: "White coats here do not rush toward patients. They move toward doubt.", hint: "Research Center", answer: "Pharmafest2026_research" }
        ];

        // --- 2. UTILITIES ---
        const resizeImage = (file, maxWidth = 800) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        // --- 3. ICONS ---
        const Icon = ({ p, c, s=24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={c}><path d={p} /></svg>;
        const Icons = {
            Camera: () => <Icon p="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />,
            MapPin: () => <Icon p="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />,
            Check: () => <Icon p="M20 6L9 17l-5-5" />,
            X: () => <Icon p="M18 6L6 18M6 6l12 12" />,
            Alert: () => <Icon p="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4m0 4h.01" />
        };

        // --- 4. MAIN APP ---
        const RxHuntApp = () => {
            const [gameState, setGameState] = useState('LOADING');
            const [teamInfo, setTeamInfo] = useState({ name: '', institute: '' });
            const [route, setRoute] = useState([]);
            const [level, setLevel] = useState(0);
            const [step, setStep] = useState('HUNT'); 
            const [inputCode, setInputCode] = useState("");
            const [photo, setPhoto] = useState(null);
            const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);
            const [gpsStatus, setGpsStatus] = useState("idle"); // idle, checking, success, fail

            const qrRef = useRef(null);
            const proofRef = useRef(null);

            useEffect(() => {
                const savedTeam = localStorage.getItem('rxTeam');
                const savedRoute = localStorage.getItem('rxRoute');
                const savedLevel = localStorage.getItem('rxLevel');

                if (savedTeam && savedRoute) {
                    setTeamInfo(JSON.parse(savedTeam));
                    setRoute(JSON.parse(savedRoute));
                    const l = parseInt(savedLevel || '0');
                    if (l >= JSON.parse(savedRoute).length) setGameState('WON');
                    else {
                        setGameState('PLAYING');
                        setLevel(l);
                    }
                } else {
                    setGameState('REGISTER');
                }
            }, []);

            const register = (e) => {
                e.preventDefault();
                const name = e.target.team.value;
                const inst = e.target.inst.value;
                if (!name || !inst) return setError("Required fields missing");

                // Generate Route: All 5 geofenced questions first, then random
                const level1Qs = QUEST_DB.filter(q => q.level === 1);
                // Randomize the order of level 1 questions? Or keep sequential?
                // Let's shuffle Level 1 for variety
                const shuffledL1 = level1Qs.sort(() => 0.5 - Math.random());
                
                // Add one level 2, one level 3 etc if needed. 
                // For now, let's just use the shuffled level 1s as the demo
                const newRoute = [...shuffledL1];

                const team = { name, institute: inst, start: Date.now() };
                localStorage.setItem('rxTeam', JSON.stringify(team));
                localStorage.setItem('rxRoute', JSON.stringify(newRoute));
                localStorage.setItem('rxLevel', 0);
                localStorage.setItem('rxProofs', JSON.stringify([]));
                
                setTeamInfo(team);
                setRoute(newRoute);
                setGameState('PLAYING');
            };

            // --- THE GEO-FENCED SCAN TRIGGER ---
            const initiateScan = () => {
                const currentQ = route[level];
                setError("");
                setGpsStatus("checking");

                // If no bounds defined (Level 2+), skip check
                if (!currentQ.bounds) {
                    setGpsStatus("success");
                    qrRef.current.click();
                    return;
                }

                if (!navigator.geolocation) {
                    setGpsStatus("fail");
                    setError("Geolocation is not supported by your browser.");
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const { north, south, east, west } = currentQ.bounds;

                        // Debug Check (Optional: Remove in production)
                        console.log(`User: ${latitude}, ${longitude}`);
                        console.log(`Target: N${north} S${south} E${east} W${west}`);

                        // CHECK IF INSIDE BOX
                        if (latitude <= north && latitude >= south && longitude <= east && longitude >= west) {
                            setGpsStatus("success");
                            qrRef.current.click(); // OPEN CAMERA PROGRAMMATICALLY
                        } else {
                            setGpsStatus("fail");
                            setError("You are NOT at the correct location. Move inside the area to scan.");
                        }
                    },
                    (err) => {
                        setGpsStatus("fail");
                        setError("Location access denied or failed. Please enable GPS.");
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            };

            const handleScanFile = async (e) => {
                if (!e.target.files.length) return;
                setLoading(true);
                setGpsStatus("idle"); 
                
                try {
                    const resizedUrl = await resizeImage(e.target.files[0], 800);
                    const res = await fetch(resizedUrl);
                    const blob = await res.blob();
                    const file = new File([blob], "qr.jpg", { type: "image/jpeg" });

                    const scanner = new Html5Qrcode("reader-hidden");
                    const text = await scanner.scanFile(file, false);
                    scanner.clear();

                    setInputCode(text);
                } catch (err) {
                    console.error(err);
                    setError("Could not read QR. Try again.");
                }
                setLoading(false);
            };

            const verifyAnswer = (e) => {
                e.preventDefault();
                const currentQ = route[level];
                
                // Flexible matching
                if (inputCode.trim().toUpperCase().includes(currentQ.answer.toUpperCase()) || 
                    currentQ.answer.toUpperCase().includes(inputCode.trim().toUpperCase())) {
                    
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    setStep('PROOF');
                } else {
                    setError("Incorrect QR Code for this location.");
                }
            };

            const submitProof = async (e) => {
                if (!e.target.files.length) return;
                try {
                    const img = await resizeImage(e.target.files[0], 600);
                    setPhoto(img);
                } catch(err) { setError("Image error"); }
            };

            const confirmLevel = () => {
                const proofs = JSON.parse(localStorage.getItem('rxProofs') || '[]');
                proofs[level] = photo;
                localStorage.setItem('rxProofs', JSON.stringify(proofs));

                const next = level + 1;
                if (next >= route.length) {
                    setGameState('WON');
                } else {
                    localStorage.setItem('rxLevel', next);
                    setLevel(next);
                    setStep('HUNT');
                    setInputCode("");
                    setPhoto(null);
                    setGpsStatus("idle");
                }
                window.scrollTo(0,0);
            };

            // --- UI RENDER ---

            if (gameState === 'LOADING') return <div className="h-screen flex items-center justify-center"><div className="spinner"></div></div>;

            if (gameState === 'REGISTER') return (
                <div className="min-h-screen bg-green-50 flex flex-col items-center justify-center p-6">
                    <div className="glass-panel w-full max-w-md p-8 rounded-3xl slide-in">
                        <div className="text-center mb-6">
                            <h1 className="text-3xl font-bold text-green-800">Rx Hunt</h1>
                            <p className="text-green-600">PharmaFest 2026</p>
                        </div>
                        <form onSubmit={register} className="space-y-4">
                            <input name="team" placeholder="Team Name" className="w-full p-4 rounded-xl border focus:border-green-500 outline-none" />
                            <input name="inst" placeholder="Institute Name" className="w-full p-4 rounded-xl border focus:border-green-500 outline-none" />
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <button className="w-full bg-green-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-green-700">Start Game</button>
                        </form>
                    </div>
                </div>
            );

            if (gameState === 'WON') return (
                <div className="min-h-screen bg-green-50 p-6 flex items-center justify-center">
                    <div className="glass-panel w-full max-w-md p-8 rounded-3xl text-center slide-in">
                        <h1 className="text-4xl font-bold text-green-800 mb-4">Mission Complete!</h1>
                        <p className="mb-6 text-gray-600">Great job, Team {teamInfo.name}. Head to the registration desk.</p>
                        <button onClick={() => {if(confirm('Reset?')) {localStorage.clear(); window.location.reload();}}} className="text-sm text-gray-400 underline">Reset App</button>
                    </div>
                </div>
            );

            // GAMEPLAY
            const q = route[level];
            
            return (
                <div className="min-h-screen bg-gradient-to-b from-green-50 to-white pb-20 relative">
                    <div id="reader-hidden" className="hidden"></div>
                    
                    {/* Header */}
                    <div className="bg-white/80 backdrop-blur-md sticky top-0 z-10 px-6 py-4 flex justify-between items-center shadow-sm">
                        <h1 className="font-bold text-green-900 select-none">Rx Hunt</h1>
                        <span className="bg-green-100 text-green-800 text-xs font-bold px-3 py-1 rounded-full">Level {level + 1}/{route.length}</span>
                    </div>

                    <div className="p-6 max-w-lg mx-auto">
                        {step === 'HUNT' ? (
                            <div className="glass-panel p-6 rounded-3xl space-y-6 slide-in">
                                {/* Clue */}
                                <div className="text-center">
                                    <div className="inline-block p-3 bg-green-100 rounded-full text-green-600 mb-3"><Icons.MapPin /></div>
                                    <h2 className="text-xl font-bold text-gray-800 mb-2">Find Location #{level + 1}</h2>
                                    <p className="text-lg text-gray-600 italic no-select">"{q.text}"</p>
                                    <p className="mt-4 text-xs text-green-600 bg-green-50 inline-block px-3 py-1 rounded-lg border border-green-100">Hint: {q.hint}</p>
                                </div>

                                {/* Scanner Logic */}
                                <div className="space-y-4">
                                    {!inputCode ? (
                                        <button onClick={initiateScan} disabled={gpsStatus === 'checking' || loading} className="w-full border-2 border-dashed border-green-300 rounded-2xl h-40 flex flex-col items-center justify-center text-green-600 hover:bg-green-50 transition-colors relative overflow-hidden">
                                            {gpsStatus === 'checking' ? (
                                                <div className="flex flex-col items-center animate-pulse">
                                                    <div className="spinner mb-2"></div>
                                                    <span className="text-sm font-semibold">Verifying GPS Location...</span>
                                                </div>
                                            ) : loading ? (
                                                <div className="spinner"></div>
                                            ) : (
                                                <><Icons.Camera /><span className="mt-2 font-semibold">Tap to Scan QR Code</span></>
                                            )}
                                        </button>
                                    ) : (
                                        <div className="bg-green-50 border border-green-200 p-4 rounded-xl text-center">
                                            <p className="text-xs text-gray-500 uppercase">Scanned Data</p>
                                            <p className="font-mono font-bold text-green-800 break-all text-sm my-2">{inputCode.substring(0, 20)}...</p>
                                            <button onClick={() => setInputCode("")} className="text-xs text-red-500 font-bold flex items-center justify-center gap-1"><Icons.X s={12}/> Rescan</button>
                                        </div>
                                    )}
                                    
                                    {inputCode && (
                                        <button onClick={verifyAnswer} className="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                                            Verify Answer
                                        </button>
                                    )}
                                </div>
                                {error && <div className="bg-red-50 text-red-600 p-3 rounded-xl text-center text-sm font-medium border border-red-100 flex items-center justify-center gap-2"><Icons.Alert s={16}/> {error}</div>}
                            </div>
                        ) : (
                            // PROOF STEP
                            <div className="glass-panel p-6 rounded-3xl space-y-6 slide-in text-center">
                                <div className="inline-block p-4 bg-green-100 rounded-full text-green-600 mb-2"><Icons.Check s={32}/></div>
                                <h2 className="text-2xl font-bold text-gray-800">Correct Location!</h2>
                                <p className="text-gray-600 text-sm">Now upload a selfie/photo to prove you are here.</p>
                                
                                {!photo ? (
                                    <button onClick={() => proofRef.current.click()} className="w-full bg-white border border-gray-200 py-6 rounded-xl shadow-sm font-semibold text-gray-600 hover:bg-gray-50">Take Photo Proof</button>
                                ) : (
                                    <div className="space-y-4">
                                        <img src={photo} className="w-full h-48 object-cover rounded-xl border border-gray-200" />
                                        <button onClick={confirmLevel} className="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg">Submit & Next Level</button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Hidden Inputs */}
                    <input type="file" ref={qrRef} accept="image/*" capture="environment" className="hidden" onChange={handleScanFile} />
                    <input type="file" ref={proofRef} accept="image/*" capture="environment" className="hidden" onChange={submitProof} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RxHuntApp />);
    </script>
</body>
</html>
